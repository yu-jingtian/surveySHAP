survey_data <- read.csv("E:/OSU/reading/Political Polarization NSF/network_formation/SHAP/ces2022.csv")
usethis::use_data(survey_data, overwrite = TRUE)
devtools::document()
library(surveySHAP)
?survey_data
devtools::document()
devtools::document()
?run_survey_shap
run_survey_shap()
run_survey_shap(survey_data)
run_survey_shap(survey_data)
devtools::document()
devtools::load_all()
run_survey_shap(survey_data)
devtools::document()
devtools::load_all()
run_survey_shap(survey_data)
shap_rslt <- run_survey_shap(survey_data)
shap_rslt$strength_main_group
shap_rslt$direction_main_active
shap_rslt$strength_interaction_group
shap_rslt$direction_interaction_active
devtools::document()
devtools::load_all()
shap_rslt <- run_survey_shap(survey_data)
sum1 <- summarize_shap_rslt(
shap_rslt,
top_n = 5,
min_n_main = 50,
min_n_interaction = 100
)
sum2 <- summarize_shap_rslt(shap_rslt, absolute = TRUE)
devtools::document()
devtools::load_all()
summary_rslt <- summarize_shap_rslt(
shap_rslt,
top_n = 5,
min_n_main = 100,
min_n_interaction = 100
)
library(surveySHAP)
?shap_interaction
?shap_interaction
?compute_shap_interaction
?shap_strength_interaction_group
?compute_shap_main
?run_survey_shap
devtools::document()
devtools::load_all()
set.seed(123)
# Use a small subset to keep this fast
dat_test <- surveySHAP_example_data
dat_test <- dat_test[sample(nrow(dat_test), 1000), ]
# Use a small subset to keep this fast
dat_test <- survey_data
dat_test <- dat_test[sample(nrow(dat_test), 1000), ]
# Run bootstrap with very small B
boot_obj <- bootstrap_survey_shap(
data = dat_test,
B = 5,
seed = 123,
parallel = FALSE,
run_args = list(
y_var = "guns_rf",
covars = c("partisan", "race", "gender", "college", "gun_own"),
interaction_subsample_n = 500
)
)
?run_survey_shap()
# Run bootstrap with very small B
boot_obj <- bootstrap_survey_shap(
data = dat_test,
B = 5,
seed = 123,
parallel = FALSE,
run_args = list(
interaction_subsample_n = 500
),
xgb_seed_per_rep = FALSE   # important: stop injecting params$seed
)
devtools::document()
devtools::load_all()
set.seed(123)
# Use a small subset to keep this fast
dat_test <- survey_data
dat_test <- dat_test[sample(nrow(dat_test), 1000), ]
# Run bootstrap with very small B
boot_obj <- bootstrap_survey_shap(
data = dat_test,
B = 5,
seed = 123,
parallel = FALSE,
run_args = list(
interaction_subsample_n = 500
),
xgb_seed_per_rep = FALSE   # important: stop injecting params$seed
)
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
set.seed(123)
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 3,
seed = 123,
parallel = FALSE,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
devtools::document()
devtools::load_all()
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
set.seed(123)
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 3,
seed = 123,
parallel = FALSE,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
devtools::document()
devtools::load_all()
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
set.seed(123)
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 3,
seed = 123,
parallel = FALSE,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
# Pass/fail checks
stopifnot(length(boot_obj$boot$failures) == 0)
stopifnot(nrow(boot_obj$boot$strength_main_mat) == 3)
stopifnot(nrow(boot_obj$boot$strength_pair_mat) == 3)
stopifnot(nrow(boot_obj$boot$dir_main_mat) == 3)
stopifnot(nrow(boot_obj$boot$dir_int_mat) == 3)
stopifnot(all(colnames(boot_obj$boot$strength_main_mat) == names(boot_obj$baseline$strength_main)))
stopifnot(all(colnames(boot_obj$boot$strength_pair_mat) == names(boot_obj$baseline$strength_pair)))
message("Bootstrap smoke test PASSED.")
summarise_bootstrap_direction(boot_obj)
?bootstrap_survey_shap
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 50,
seed = 123,
parallel = FALSE,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 50,
seed = 123,
parallel = TRUE,
n_cores = 5,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
devtools::document()
devtools::load_all()
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 50,
seed = 123,
parallel = TRUE,
n_cores = 5,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
devtools::document()
devtools::load_all()
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 50,
seed = 123,
parallel = TRUE,
n_cores = 5,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
devtools::document()
devtools::load_all()
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 50,
seed = 123,
parallel = TRUE,
n_cores = 5,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
devtools::document()
devtools::load_all()
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 50,
seed = 123,
parallel = TRUE,
n_cores = 5,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
devtools::install_github("yu-jingtian/surveySHAP")
detach("surveySHAP", unload=TRUE)
detach("package:surveySHAP", unload=TRUE)
devtools::install_github("yu-jingtian/surveySHAP")
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
## ------------------------------------------------------------
## Smoke test for surveySHAP bootstrap
## ------------------------------------------------------------
library(surveySHAP)
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 50,
seed = 123,
parallel = TRUE,
n_cores = 5,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
detach("package:surveySHAP", unload=TRUE)
devtools::install_github("yu-jingtian/surveySHAP")
## ------------------------------------------------------------
## Smoke test for surveySHAP bootstrap
## ------------------------------------------------------------
library(surveySHAP)
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
boot_obj <- bootstrap_survey_shap(
data = dat,
B = 50,
seed = 123,
parallel = TRUE,
n_cores = 5,
run_args = list(interaction_subsample_n = 500),
verbose = FALSE
)
summarise_bootstrap_direction(boot_obj)
# Strength summaries (group + group-pairs)
sum_strength <- summarise_bootstrap_strength(boot_obj, conf = 0.95, top_k = 5)
sum_strength
# Direction summaries (main + interaction)
sum_dir <- summarise_bootstrap_direction(boot_obj, conf = 0.95, top_k = 8)
sum_dir
top_oneway <- sum_strength$oneway[order(-sum_strength$oneway$estimate), ][1:5, ]
top_oneway
top_twoway <- sum_strength$twoway[order(-sum_strength$twoway$estimate), ][1:8, ]
top_twoway
dir_main_stable <- subset(
sum_dir$main,
present_prob >= 0.9 & (ci_lo > 0 | ci_hi < 0)
)
dir_main_stable <- dir_main_stable[order(-abs(dir_main_stable$estimate)), ][1:10, ]
dir_main_stable
dir_int_stable <- subset(
sum_dir$interaction,
present_prob >= 0.8 & (ci_lo > 0 | ci_hi < 0)
)
dir_int_stable <- dir_int_stable[order(-abs(dir_int_stable$estimate)), ][1:10, ]
dir_int_stable
dir_main_stable[order(-abs(dir_main_stable$estimate)), ]
sum_dir
View(sum_dir)
sum_dir[["main"]]
View(sum_dir[["main"]])
subset(
sum_dir$main,
present_prob >= 0.9 & (ci_lo > 0 | ci_hi < 0)
)
dir_main_stable
dir_main_stable <- subset(
sum_dir$main,
present_prob >= 0.9 & (ci_lo > 0 | ci_hi < 0)
)
dir_main_stable <- dir_main_stable[order(-abs(dir_main_stable$estimate)), , drop = FALSE]
dir_main_stable <- head(dir_main_stable, 10)
dir_main_stable
dir_int_stable <- dir_int_stable[order(-abs(dir_int_stable$estimate)), , drop = FALSE]
dir_int_stable <- head(dir_int_stable, 10)
dir_int_stable
dir_int_stable <- subset(
sum_dir$interaction,
present_prob >= 0.8 & (ci_lo > 0 | ci_hi < 0)
)
dir_int_stable <- dir_int_stable[order(-abs(dir_int_stable$estimate)), , drop = FALSE]
dir_int_stable <- head(dir_int_stable, 10)
dir_int_stable
View(dir_int_stable)
# Strength summaries (group + group-pairs)
sum_strength <- summarise_bootstrap_strength(boot_obj, conf = 0.95, top_k = 5)
# Direction summaries (main + interaction)
sum_dir <- summarise_bootstrap_direction(boot_obj, conf = 0.95, top_k = 5)
# Strength summaries (group + group-pairs)
sum_strength <- summarise_bootstrap_strength(boot_obj, conf = 0.95, top_k = 5)
top_oneway <- sum_strength$oneway[order(-sum_strength$oneway$estimate), ][1:5, ]
top_oneway
top_twoway <- sum_strength$twoway[order(-sum_strength$twoway$estimate), ][1:5, ]
top_twoway
dir_main_stable <- subset(
sum_dir$main,
present_prob >= 0.9 & (ci_lo > 0 | ci_hi < 0)
)
dir_main_stable <- dir_main_stable[order(-abs(dir_main_stable$estimate)), , drop = FALSE]
dir_main_stable <- head(dir_main_stable, 10)
dir_main_stable
dir_int_stable <- subset(
sum_dir$interaction,
present_prob >= 0.8 & (ci_lo > 0 | ci_hi < 0)
)
dir_int_stable <- dir_int_stable[order(-abs(dir_int_stable$estimate)), , drop = FALSE]
dir_int_stable <- head(dir_int_stable, 10)
dir_int_stable
View(top_twoway)
View(top_oneway)
View(dir_int_stable)
View(dir_main_stable)
View(dir_int_stable)
library(surveySHAP)
# Load package functions (adjust if using devtools)
data(survey_data)
str(survey_data)
set.seed(123)
# Use a small subset to keep this fast
dat <- survey_data
dat <- dat[sample(nrow(dat), 1000), ]
# main strength
out1 <- boot_strength(dat, feature = "partisan", B = 30, seed = 1, parallel = FALSE)
out1$summary
# main strength
out1 <- boot_strength(dat, feature = "partisan", B = 30, seed = 1, parallel = T)
# Use a small subset to keep this fast
dat <- survey_data
# main strength
out1 <- boot_strength(dat, feature = "partisan", B = 30, seed = 1, parallel = T)
out1$summary
system.time({
tmp <- boot_strength(df, "partisan", B = 1, seed = 1, parallel = FALSE)
})
system.time({
tmp <- boot_strength(dat, "partisan", B = 1, seed = 1, parallel = FALSE)
})
devtools::document()
devtools::load_all()
library(surveySHAP)
# Load package functions (adjust if using devtools)
data(survey_data)
str(survey_data)
set.seed(123)
system.time({
tmp <- boot_strength(dat, "partisan", B = 1, seed = 1, parallel = FALSE)
})
## Timing: note B=1 does (baseline + 1 bootstrap) = 2 fits
system.time({
tmp <- boot_strength(
data = dat,
feature = "partisan",
B = 1,
seed = 1,
parallel = FALSE,
xgb_nthread = parallel::detectCores()  # use all threads when NOT parallelizing bootstraps
)
})
## Main strength (parallel bootstrap):
## IMPORTANT: limit xgboost to 1 thread per worker to avoid CPU oversubscription
out1 <- boot_strength(
data = dat,
feature = "partisan",
B = 30,
seed = 1,
parallel = TRUE,
n_cores = 8,
xgb_nthread = 1
)
out1$summary
## Main strength (parallel bootstrap):
## IMPORTANT: limit xgboost to 1 thread per worker to avoid CPU oversubscription
out1 <- boot_strength(
data = dat,
feature = "partisan",
B = 30,
seed = 1,
parallel = TRUE,
n_cores = 8,
xgb_nthread = 1
)
out1$summary
devtools::document()
devtools::load_all()
library(surveySHAP)
## Main strength (parallel bootstrap):
## IMPORTANT: limit xgboost to 1 thread per worker to avoid CPU oversubscription
out1 <- boot_strength(
data = dat,
feature = "partisan",
B = 30,
seed = 1,
parallel = TRUE,
n_cores = 8,
xgb_nthread = 1
)
out1$summary
devtools::document()
devtools::load_all()
## Timing: note B=1 does (baseline + 1 bootstrap) = 2 fits
system.time({
tmp <- boot_strength(
data = dat,
feature = "partisan",
B = 1,
seed = 1,
parallel = FALSE,
xgb_nthread = parallel::detectCores()  # use all threads when NOT parallelizing bootstraps
)
})
## Timing: note B=1 does (baseline + 1 bootstrap) = 2 fits
system.time({
tmp <- boot_strength(
data = dat,
feature = "partisan",
B = 1,
seed = 1,
parallel = FALSE
)
})
## Main strength (parallel bootstrap):
## IMPORTANT: limit xgboost to 1 thread per worker to avoid CPU oversubscription
out1 <- boot_strength(
data = dat,
feature = "partisan",
B = 30,
seed = 1,
parallel = TRUE,
n_cores = 8
)
## Main strength (parallel bootstrap):
## IMPORTANT: limit xgboost to 1 thread per worker to avoid CPU oversubscription
system.time({
out1 <- boot_strength(
data = dat,
feature = "partisan",
B = 30,
seed = 1,
parallel = TRUE,
n_cores = 8
)
})
system.time({
out1 <- boot_strength(
data = dat,
feature = "partisan",
B = 30,
seed = 1,
parallel = FALSE
)
})
out1$summary
out1 <- boot_strength(
data = dat,
feature = "partisan",
B = 30,
seed = 1,
parallel = TRUE,
n_cores = 8
)
out1$summary
Sys.setenv(OMP_NUM_THREADS = "1")
Sys.setenv(OPENBLAS_NUM_THREADS = "1")
Sys.setenv(MKL_NUM_THREADS = "1")
system.time({
out1 <- boot_strength(
data = dat,
feature = "partisan",
B = 30,
seed = 1,
parallel = TRUE,
n_cores = 8
)
})
