filter(year==year_select)
policy$case_id <- as.numeric(policy$case_id)
data <- inner_join(demo, policy, by="case_id")
data[] <- lapply(data, function(x) { attributes(x) <- NULL; x })
### immig policy
df_immig <- data %>% select(immig_legalize, immig_border)
df_immig <- 2 -  as.data.frame(lapply(df_immig, function(x) as.vector(as.numeric(x))))
df_immig[,1] <- -df_immig[,1]
df_immig[,2] <- df_immig[,2]
data$immig <- rowSums(df_immig)
### enviro policy
df_enviro <- data %>% select(enviro_carbon, enviro_renewable,
enviro_airwateracts)
df_enviro <- 2 -  as.data.frame(lapply(df_enviro, function(x) as.vector(as.numeric(x))))
df_enviro[,1] <- df_enviro[,1]
df_enviro[,2] <- df_enviro[,2]
df_enviro[,3] <- df_enviro[,3]
data$enviro <- rowSums(df_enviro)
### abortion policy
df_abortion <- data %>% select(abortion_always, abortion_conditional,
abortion_20weeks, abortion_prohibition)
df_abortion <- 2 -  as.data.frame(lapply(df_abortion, function(x) as.vector(as.numeric(x))))
df_abortion[,1] <- -df_abortion[,1]
df_abortion[,2] <- df_abortion[,2]
df_abortion[,3] <- df_abortion[,3]
df_abortion[,4] <- df_abortion[,4]
data$abortion <- rowSums(df_abortion)
# gun control policy
df_guns <- data %>% select(guns_assaultban, guns_permits)
df_guns <- 2 -  as.data.frame(lapply(df_guns, function(x) as.vector(as.numeric(x))))
df_guns[,1] <- df_guns[,1]
df_guns[,2] <- -df_guns[,2]
data$guns <- rowSums(df_guns)
### healthcare policy
df_healthcare <- data %>% select(healthcare_aca, healthcare_acamandate,
healthcare_medicare)
df_healthcare <- 2 -  as.data.frame(lapply(df_healthcare, function(x) as.vector(as.numeric(x))))
df_healthcare[,1] <- -df_healthcare[,1]
df_healthcare[,2] <- df_healthcare[,2]
df_healthcare[,3] <- df_healthcare[,3]
data$healthcare <- rowSums(df_healthcare)
### military policy
df_military <- data %>% select(military_oil, military_terroristcamp,
military_genocide, military_democracy,
military_protectallies, military_helpun)
df_military <- 2 -  as.data.frame(lapply(df_military, function(x) as.vector(as.numeric(x))))
df_military[,1] <- df_military[,1]
df_military[,2] <- df_military[,2]
df_military[,3] <- df_military[,3]
df_military[,4] <- df_military[,4]
df_military[,5] <- df_military[,5]
df_military[,6] <- df_military[,6]
data$military <- rowSums(df_military)
### spending policy
df_spending <- data %>% select(spending_welfare, spending_healthcare,
spending_education, spending_police,
spending_infrastructure)
df_spending <- as.data.frame(lapply(df_spending, function(x) as.vector(as.numeric(x))))
df_spending[,1] <- df_spending[,1]
df_spending[,2] <- df_spending[,2]
df_spending[,3] <- df_spending[,3]
df_spending[,4] <- -df_spending[,4]
df_spending[,5] <- df_spending[,5]
data$spending <- rowSums(df_spending)
### trade policy
df_trade <- data %>% select(trade_china, trade_canmex_include)
df_trade <- 2 -  as.data.frame(lapply(df_trade, function(x) as.vector(as.numeric(x))))
df_trade[,1] <- df_trade[,1]
df_trade[,2] <- df_trade[,2]
data$trade <- rowSums(df_trade)
data$race <- ifelse(data$race==1, "White",
ifelse(data$race==2, "Black",
ifelse(data$race==3, "Hipanic",
ifelse(data$race==4, "Asian", NA))))
data$gender <- ifelse(data$gender==1, "Male", "Female")
data$partisan <- ifelse(data$pid3==1, "Dem.",
ifelse(data$pid3==2, "Rep.",
ifelse(data$pid3==3, "Ind.", NA)))
data <- data %>% select(!c(year.x, year.y, pid3)) %>% remove_labels()
final_select <- c("case_id", "partisan", "race",
"gender", "age", "educ", "rural_urban",
"weight_cumulative", "immig", "enviro", "abortion", "guns",
"healthcare", "military", "spending", "trade")
data <- data %>% select(all_of(final_select))
# convert to factor
non_factor <- c("age", "educ", "rural_urban", "weight_cumulative",
"immig", "enviro", "abortion", "guns",
"healthcare", "military", "spending", "trade")
cols_to_convert <- setdiff(names(data), non_factor)
data[, cols_to_convert] <- lapply(data[, cols_to_convert], as.factor)
if (year_select == 2018){
data <- data %>% select(-immig)
}
if (year_select == 2014){
data <- data %>% select(-abortion)
}
if (year_select %in% seq(2014, 2018)){
data <- data %>% select(-healthcare)
}
if (year_select %in% c(2017, 2018, 2019, 2021)){
data <- data %>% select(-military)
}
if (year_select %in% c(2015, 2017, 2019, 2021)){
data <- data %>% select(-spending)
}
if (year_select %in% c(2014, 2015, 2016, 2017)){
data <- data %>% select(-trade)
}
data <- na.omit(data)
print(year_select)
print(nrow(data))
normalize_func <- function(vector){
# Calculate the minimum and maximum values
min_value <- min(vector, na.rm = T)
max_value <- max(vector, na.rm = T)
return((vector - min_value) / (max_value - min_value))
}
if (year_select == 2018){
data$immig <- NA
} else {
data$immig <- normalize_func(data$immig)
}
if (year_select == 2014){
data$abortion <- NA
} else {
data$abortion <- normalize_func(data$abortion)
}
if (year_select %in% seq(2014, 2018)){
data$healthcare <- NA
} else {
data$healthcare <- normalize_func(data$healthcare)
}
if (year_select %in% c(2017, 2018, 2019, 2021)){
data$military <- NA
} else {
data$military <- normalize_func(data$military)
}
if (year_select %in% c(2015, 2017, 2019, 2021)){
data$spending <- NA
} else {
data$spending <- normalize_func(data$spending)
}
if (year_select %in% c(2014, 2015, 2016, 2017)){
data$trade <- NA
} else {
data$trade <- normalize_func(data$trade)
}
data$enviro <- normalize_func(data$enviro)
data$guns <- normalize_func(data$guns)
return(data)
}
year_list <- seq(2014, 2021)
policy_list <- c("immig", "enviro", "abortion", "guns", "healthcare", "military", "spending", "trade")
for (i in 1:length(year_list)){
print(year_list[i])
data <- data_processing_raw(ces_cumulative, table, year_select = year_list[i])
data[data == 0] <- NA
write.csv(data, paste0("plot_policy_2026_github\\policy_", year_list[i], ".csv"),
row.names = F)
}
year_list <- seq(2014, 2021)
policy_raw <- vector("list", length(year_list))
policy_rf <- vector("list", length(year_list))
demographics <- vector("list", length(year_list))
for (i in 1:length(year_list)){
print(year_list[i])
df <- read.csv(paste0("plot_policy_2026_github\\policy_", year_list[i], ".csv"))
df_year <- data.frame(year = rep(year_list[i], nrow(df)))
df_raw <- df %>% select(c("case_id", "immig", "enviro", "abortion",
"guns", "healthcare", "military", "spending", "trade"))
policy_raw[[i]] <- cbind(df_year, df_raw)
df_demographics <- df %>% select(c("case_id", "partisan", "race", "gender",
"age", "educ", "rural_urban", "weight_cumulative"))
demographics[[i]] <- cbind(df_year, df_demographics)
df <- read.csv(paste0("plot_policy_2026_github\\policy_pred_", year_list[i], ".csv"))
df_year <- data.frame(year = rep(year_list[i], nrow(df)))
df_rf <- df %>% select(c("case_id", "immig_pred", "enviro_pred", "abortion_pred",
"guns_pred", "healthcare_pred", "military_pred",
"spending_pred", "trade_pred"))
policy_rf[[i]] <- cbind(df_year, df_rf)
colnames(policy_rf[[i]]) <- c("year", "case_id", "immig_rf", "enviro_rf", "abortion_rf",
"guns_rf", "healthcare_rf", "military_rf",
"spending_rf", "trade_rf")
}
policy_raw <- bind_rows(policy_raw)
policy_rf <- bind_rows(policy_rf)
demographics <- bind_rows(demographics)
View(policy_raw)
View(policy_rf)
year_list <- seq(2014, 2021)
policy_list <- c("immig", "enviro", "abortion", "guns", "healthcare", "military", "spending", "trade")
for (i in 1:length(year_list)){
print(year_list[i])
df_rslt <- pred_func(policy_list, ces_cumulative, table, year_list[i])
write.csv(df_rslt, paste0("plot_policy_2026_github\\policy_pred_", year_list[i], ".csv"),
row.names = F)
}
year_list <- seq(2014, 2021)
policy_list <- c("immig", "enviro", "abortion", "guns", "healthcare", "military", "spending", "trade")
for (i in 1:length(year_list)){
print(year_list[i])
data <- data_processing_raw(ces_cumulative, table, year_select = year_list[i])
data[data == 0] <- NA
write.csv(data, paste0("plot_policy_2026_github\\policy_", year_list[i], ".csv"),
row.names = F)
}
year_list <- seq(2014, 2021)
policy_raw <- vector("list", length(year_list))
policy_rf <- vector("list", length(year_list))
demographics <- vector("list", length(year_list))
for (i in 1:length(year_list)){
print(year_list[i])
df <- read.csv(paste0("plot_policy_2026_github\\policy_", year_list[i], ".csv"))
df_year <- data.frame(year = rep(year_list[i], nrow(df)))
df_raw <- df %>% select(c("case_id", "immig", "enviro", "abortion",
"guns", "healthcare", "military", "spending", "trade"))
policy_raw[[i]] <- cbind(df_year, df_raw)
df_demographics <- df %>% select(c("case_id", "partisan", "race", "gender",
"age", "educ", "rural_urban", "weight_cumulative"))
demographics[[i]] <- cbind(df_year, df_demographics)
df <- read.csv(paste0("plot_policy_2026_github\\policy_pred_", year_list[i], ".csv"))
df_year <- data.frame(year = rep(year_list[i], nrow(df)))
df_rf <- df %>% select(c("case_id", "immig_pred", "enviro_pred", "abortion_pred",
"guns_pred", "healthcare_pred", "military_pred",
"spending_pred", "trade_pred"))
policy_rf[[i]] <- cbind(df_year, df_rf)
colnames(policy_rf[[i]]) <- c("year", "case_id", "immig_rf", "enviro_rf", "abortion_rf",
"guns_rf", "healthcare_rf", "military_rf",
"spending_rf", "trade_rf")
}
policy_raw <- bind_rows(policy_raw)
policy_rf <- bind_rows(policy_rf)
demographics <- bind_rows(demographics)
View(df_raw)
year_list <- seq(2014, 2021)
policy_list <- c("immig", "enviro", "abortion", "guns", "healthcare", "military", "spending", "trade")
for (i in 1:length(year_list)){
print(year_list[i])
data <- data_processing_raw(ces_cumulative, table, year_select = year_list[i])
write.csv(data, paste0("plot_policy_2026_github\\policy_", year_list[i], ".csv"),
row.names = F)
}
year_list <- seq(2014, 2021)
policy_raw <- vector("list", length(year_list))
policy_rf <- vector("list", length(year_list))
demographics <- vector("list", length(year_list))
for (i in 1:length(year_list)){
print(year_list[i])
df <- read.csv(paste0("plot_policy_2026_github\\policy_", year_list[i], ".csv"))
df_year <- data.frame(year = rep(year_list[i], nrow(df)))
df_raw <- df %>% select(c("case_id", "immig", "enviro", "abortion",
"guns", "healthcare", "military", "spending", "trade"))
policy_raw[[i]] <- cbind(df_year, df_raw)
df_demographics <- df %>% select(c("case_id", "partisan", "race", "gender",
"age", "educ", "rural_urban", "weight_cumulative"))
demographics[[i]] <- cbind(df_year, df_demographics)
df <- read.csv(paste0("plot_policy_2026_github\\policy_pred_", year_list[i], ".csv"))
df_year <- data.frame(year = rep(year_list[i], nrow(df)))
df_rf <- df %>% select(c("case_id", "immig_pred", "enviro_pred", "abortion_pred",
"guns_pred", "healthcare_pred", "military_pred",
"spending_pred", "trade_pred"))
policy_rf[[i]] <- cbind(df_year, df_rf)
colnames(policy_rf[[i]]) <- c("year", "case_id", "immig_rf", "enviro_rf", "abortion_rf",
"guns_rf", "healthcare_rf", "military_rf",
"spending_rf", "trade_rf")
}
policy_raw <- bind_rows(policy_raw)
policy_rf <- bind_rows(policy_rf)
demographics <- bind_rows(demographics)
View(df_raw)
getwd()
setwd("E:/jingtian_git/surveyMDV")
use_data(
policy_raw,
policy_rf,
demographics,
overwrite = TRUE
)
getwd()
devtools::document()
library(surveyMDV)
?policy_raw
devtools::document()
?policy_raw
?get_policy_rf
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(data.table)
library(igraph)
library(ggplot2)
library(anocva)
library(ggdendro)
library(reshape2)
library(MASS)
library(labelled)
library(gridExtra)
library(formattable)
select <- dplyr::select
library(scales)
library(Peacock.test)
library(foreach)
library(doParallel)
library(patchwork)
library(ggcorrplot)
library(pdp)
library(ranger)
library(haven)
library(stringr)
library(car)
library(emmeans)
library(randomForest)
library(ordinalForest)
library(xgboost)
library(Matrix)
library(SHAPforxgboost)
data_processing <- function(ces22, party, state){
data <- ces22 %>% select(c("gunown","CC22_330a","CC22_330b","CC22_330c",
"CC22_330d","CC22_330e","CC22_330f",
"pid3", "countyfips", "race", "gender4", "educ"))
# columns (1 = support, 2 = oppose)
gun_vars     <- c("CC22_330a","CC22_330b","CC22_330c",
"CC22_330d","CC22_330e","CC22_330f")
# items where "support" means looser control -> reverse
reverse_vars <- c("CC22_330a","CC22_330c","CC22_330f")
# 1) pull to a numeric matrix
M <- as.matrix(ces22[, gun_vars])
# 2) recode to 1 = stricter, 0 = looser, else NA (vectorized)
M[] <- ifelse(M == 1, 1, ifelse(M == 2, 0, NA_real_))
# 3) reverse the specified columns (still vectorized)
rev_idx <- match(reverse_vars, gun_vars)
M[, rev_idx] <- 1 - M[, rev_idx]
# 4) fast row-level stats
n_ans   <- rowSums(!is.na(M))
gun_sum <- rowSums(M, na.rm = TRUE)           # counts stricter responses (0–6)
# --- Option B: normalize by observed range (your proposal) ---
rng <- range(gun_sum, na.rm = TRUE)
den <- diff(rng)
gun_score <- if (den > 0) (gun_sum - rng[1]) / den else rep(NA_real_, length(gun_sum))
data$gun_control <- gun_score
data <- data %>%
mutate(
countyfips = str_pad(as.character(countyfips), width = 5, pad = "0")
)
data <- data %>%
mutate(
gun_own = factor(
gunown,
levels = c(1, 2, 3, 8),
labels = c("Own a gun",
"HH owns (not self)",
"No guns in HH",
"Not sure")
)
)
data <- data %>%
mutate(
partisan = factor(
pid3,
levels = c(1, 2, 3),
labels = c("Dem.", "Rep.", "Ind.")
),
race = factor(
race,
levels = c(1, 2, 3, 4),
labels = c("White", "Black", "Hipanic", "Asian")
),
gender = factor(
ifelse(gender4 == 1, "Men",
ifelse(gender4 == 2, "Woman",
ifelse(gender4 %in% c(3,4), "Other", NA))),
levels = c("Men", "Woman", "Other")
),
college = factor(
ifelse(educ %in% c(1,2,3), "Non-college",
ifelse(educ %in% c(4,5,6), "College", NA)),
levels = c("Non-college", "College")
)
)
data <- data %>% select(c("gun_control", "gun_own", "partisan", "race", "gender", "college", "countyfips"))
if (party != "all"){
data <- data %>% filter(partisan == party)
}
if (state != "all"){
data <- data %>% filter(substr(countyfips, 1, 2) == state)
}
return(data)
}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(data.table)
library(igraph)
library(ggplot2)
library(anocva)
library(ggdendro)
library(reshape2)
library(MASS)
library(labelled)
library(gridExtra)
library(formattable)
select <- dplyr::select
library(scales)
library(Peacock.test)
library(foreach)
library(doParallel)
library(patchwork)
library(ggcorrplot)
library(pdp)
library(ranger)
library(haven)
library(stringr)
library(car)
library(emmeans)
library(randomForest)
library(ordinalForest)
library(xgboost)
library(Matrix)
library(SHAPforxgboost)
data_processing <- function(ces22, party, state){
data <- ces22 %>% select(c("gunown","CC22_330a","CC22_330b","CC22_330c",
"CC22_330d","CC22_330e","CC22_330f",
"pid3", "countyfips", "race", "gender4", "educ"))
# columns (1 = support, 2 = oppose)
gun_vars     <- c("CC22_330a","CC22_330b","CC22_330c",
"CC22_330d","CC22_330e","CC22_330f")
# items where "support" means looser control -> reverse
reverse_vars <- c("CC22_330a","CC22_330c","CC22_330f")
# 1) pull to a numeric matrix
M <- as.matrix(ces22[, gun_vars])
# 2) recode to 1 = stricter, 0 = looser, else NA (vectorized)
M[] <- ifelse(M == 1, 1, ifelse(M == 2, 0, NA_real_))
# 3) reverse the specified columns (still vectorized)
rev_idx <- match(reverse_vars, gun_vars)
M[, rev_idx] <- 1 - M[, rev_idx]
# 4) fast row-level stats
n_ans   <- rowSums(!is.na(M))
gun_sum <- rowSums(M, na.rm = TRUE)           # counts stricter responses (0–6)
# --- Option B: normalize by observed range (your proposal) ---
rng <- range(gun_sum, na.rm = TRUE)
den <- diff(rng)
gun_score <- if (den > 0) (gun_sum - rng[1]) / den else rep(NA_real_, length(gun_sum))
data$gun_control <- gun_score
data <- data %>%
mutate(
countyfips = str_pad(as.character(countyfips), width = 5, pad = "0")
)
data <- data %>%
mutate(
gun_own = factor(
gunown,
levels = c(1, 2, 3, 8),
labels = c("Own a gun",
"HH owns (not self)",
"No guns in HH",
"Not sure")
)
)
data <- data %>%
mutate(
partisan = factor(
pid3,
levels = c(1, 2, 3),
labels = c("Dem.", "Rep.", "Ind.")
),
race = factor(
race,
levels = c(1, 2, 3, 4),
labels = c("White", "Black", "Hipanic", "Asian")
),
gender = factor(
ifelse(gender4 == 1, "Men",
ifelse(gender4 == 2, "Woman",
ifelse(gender4 %in% c(3,4), "Other", NA))),
levels = c("Men", "Woman", "Other")
),
college = factor(
ifelse(educ %in% c(1,2,3), "Non-college",
ifelse(educ %in% c(4,5,6), "College", NA)),
levels = c("Non-college", "College")
)
)
data <- data %>% select(c("gun_control", "gun_own", "partisan", "race", "gender", "college", "countyfips"))
if (party != "all"){
data <- data %>% filter(partisan == party)
}
if (state != "all"){
data <- data %>% filter(substr(countyfips, 1, 2) == state)
}
return(data)
}
ces22 <- read_dta("CCES22_Common_OUTPUT_vv_topost.dta")
data <- data_processing(ces22, "all", "all")
data <- data %>% select("gun_control", "gun_own", "partisan", "race", "gender", "college")
write.csv(data,
"E:/OSU/reading/Political Polarization NSF/network_formation/SHAP",
row.names = F)
write.csv(data, file="SHAP/", row.names = F)
getwd()
setwd("E:/OSU/reading/Political Polarization NSF/network_formation/")
write.csv(data, file="SHAP/", row.names = F)
?write.csv
write.csv(data, file="SHAP/", row.names = F)
write.csv(data, file="SHAP/ces2022.csv", row.names = F)
data <- read.csv("SHAP/ces2022.csv")
library(roxygen2)
setwd("E:/jingtian_git")
usethis::create_package("surveySHAP")
survey_data <- data
setwd("E:/jingtian_git/surveySHAP")
usethis::use_data(survey_data, overwrite = TRUE)
getwd()
